<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard - SEBI Saathi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; 
    }
    .font-display { font-family: 'Manrope', sans-serif; }
    .modal-backdrop { background: rgba(15, 23, 42, 0.6); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-gray-100">
  <header class="bg-white/80 backdrop-blur-sm border-b border-gray-200 px-6 py-4 sticky top-0 z-50">
    <div class="flex items-center justify-between max-w-7xl mx-auto">
      <div class="flex items-center space-x-4">
        <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-700 rounded-xl flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl font-bold font-display text-gray-900">SEBI Saathi</h1>
          <p class="text-sm text-gray-600 font-medium">Portfolio Dashboard</p>
        </div>
      </div>
      <div class="flex gap-3 items-center">
        <a href="/" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
          </svg>
          Chat Assistant
        </a>
        <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="p-6 max-w-7xl mx-auto">
    <section class="grid grid-cols-1 xl:grid-cols-4 gap-6 mb-8">
      <div class="xl:col-span-3 bg-white/70 backdrop-blur-sm rounded-2xl border border-gray-200 p-6 shadow-sm">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="font-bold text-xl font-display text-gray-900">Portfolio Overview</h2>
            <p class="text-gray-600 text-sm mt-1">Your investment holdings and performance</p>
          </div>
          <div class="text-right">
            <p class="text-sm text-gray-600 font-medium">Total Portfolio Value</p>
            <p class="text-2xl font-bold font-display text-gray-900" id="totalValue">—</p>
          </div>
        </div>

        <div id="holdingsTableWrap" class="overflow-auto rounded-xl border border-gray-200 mb-4">
          <table class="w-full text-sm">
            <thead class="bg-gray-50">
              <tr class="text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                <th class="p-4">Symbol</th>
                <th class="p-4">Quantity</th>
                <th class="p-4">Avg Price</th>
                <th class="p-4">Last Price</th>
                <th class="p-4">Current Value</th>
              </tr>
            </thead>
            <tbody id="holdingsBody" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>

        <!-- Portfolio 6-month line chart -->
        <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h4 class="font-semibold text-gray-900">Portfolio value — last 6 months</h4>
              <p class="text-xs text-gray-500">Daily/weekly values plotted (backend must provide /portfolio/history).</p>
            </div>
            <button id="refreshHistoryBtn" class="text-xs px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200">Refresh</button>
          </div>
          <div style="height:320px">
            <canvas id="portfolioLineChart" style="width:100%;height:100%"></canvas>
          </div>
        </div>
      </div>

      <aside class="bg-white/70 backdrop-blur-sm rounded-2xl border border-gray-200 p-6 shadow-sm">
        <h3 class="font-bold text-lg font-display text-gray-900 mb-6">Portfolio Actions</h3>

        <div class="mb-8 p-4 bg-gray-50 rounded-xl border border-gray-200">
          <label class="block text-sm font-semibold text-gray-900 mb-3">Upload Portfolio File</label>
          <p class="text-xs text-gray-600 mb-3">Supported formats: CSV, XLSX</p>
          <input id="portfolioFile" type="file" accept=".csv,.xls,.xlsx" 
                 class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 file:cursor-pointer cursor-pointer" />
          <button id="uploadPortfolioBtn" 
                  class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-semibold transition-colors">
            Upload & Analyze
          </button>
        </div>

        <div class="p-4 bg-gradient-to-br from-gray-50 to-slate-50 rounded-xl border border-gray-200">
          <h4 class="font-semibold text-gray-900 mb-4 font-display">Asset Allocation</h4>
          <div class="flex justify-center">
            <canvas id="allocChart" width="280" height="280"></canvas>
          </div>
        </div>
      </aside>
    </section>

    <section class="bg-white/70 backdrop-blur-sm rounded-2xl border border-gray-200 p-6 shadow-sm mb-6">
      <div class="flex items-center mb-6">
        <div class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center mr-3">
          <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
          </svg>
        </div>
        <div>
          <h3 class="font-bold text-lg font-display text-gray-900">Market Alerts</h3>
          <p class="text-gray-600 text-sm">Based on recent market headlines and news</p>
        </div>
      </div>
      <div id="alertsList" class="space-y-4"></div>
    </section>

    <!-- IPO Reports Section -->
    <section class="bg-white/70 backdrop-blur-sm rounded-2xl border border-gray-200 p-6 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="font-bold text-lg font-display text-gray-900">IPO Reports</h3>
          <p class="text-sm text-gray-600">Saved IPO analyses for your account. View, compare, or generate new reports.</p>
        </div>
        <div class="flex items-center gap-3">
          <button id="openIpoAnalyzerBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium">Analyze IPO</button>
          <button id="refreshIpoBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">Refresh</button>
          <button id="compareIpoBtn" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm font-semibold">Compare Selected</button>
        </div>
      </div>

      <div id="ipoList" class="space-y-3"></div>

      <div id="ipoCompareResult" class="mt-6 hidden">
        <h4 class="font-semibold text-gray-900 mb-3">Comparison</h4>
        <div class="overflow-auto rounded-lg border border-gray-200 bg-white p-3">
          <table id="ipoCompareTable" class="w-full text-sm">
            <thead class="bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase">
              <tr>
                <th class="p-2">Title</th>
                <th class="p-2">Created At</th>
                <th class="p-2">Revenue</th>
                <th class="p-2">Profit</th>
                <th class="p-2">Debt</th>
                <th class="p-2">Promoter</th>
                <th class="p-2">Score</th>
              </tr>
            </thead>
            <tbody id="ipoCompareBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- IPO Analyzer Modal -->
  <div id="ipoAnalyzerModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="relative bg-white rounded-2xl p-6 z-50 w-full max-w-3xl max-h-[90vh] overflow-auto border border-gray-200">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h3 class="text-lg font-semibold font-display text-gray-900">IPO Analyzer</h3>
          <p class="text-sm text-gray-600">Upload a prospectus PDF or paste content. Results will be saved to your account.</p>
        </div>
        <div class="flex gap-2">
          <button id="closeIpoAnalyzer" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">Close</button>
        </div>
      </div>

      <form id="ipoAnalyzerForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload IPO Document (PDF)</label>
          <input id="ipoFileInput" type="file" accept=".pdf,.txt" class="w-full border border-gray-300 rounded-lg px-3 py-2"/>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Or paste IPO content</label>
          <textarea id="ipoTextInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 h-36" placeholder="Paste prospectus text (first 100k chars recommended)"></textarea>
        </div>

        <div class="flex gap-3">
          <button id="analyzeIpoBtn" type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium">Analyze</button>
          <button id="saveIpoBtn" type="button" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium hidden">Save report</button>
          <button id="refreshReportsAfterSave" type="button" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm hidden">Refresh Reports</button>
        </div>
      </form>

      <div id="ipoResultArea" class="mt-4 prose max-w-none text-sm"></div>
    </div>
  </div>

  <!-- Modal: View IPO Report -->
  <div id="ipoModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="relative bg-white rounded-2xl p-6 z-50 w-full max-w-4xl max-h-[85vh] overflow-auto border border-gray-200">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h3 id="ipoModalTitle" class="text-lg font-semibold font-display text-gray-900">IPO Report</h3>
          <p id="ipoModalMeta" class="text-sm text-gray-600 mt-1"></p>
        </div>
        <div class="flex gap-2 items-center">
          <button id="ipoModalOpenRaw" class="text-sm text-gray-600 hover:text-gray-900">Open raw</button>
          <button id="ipoModalClose" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">Close</button>
        </div>
      </div>
      <div id="ipoModalContent" class="prose max-w-none text-sm text-gray-800 whitespace-pre-wrap"></div>
    </div>
  </div>

  <script>
    const totalValueEl = document.getElementById('totalValue');
    const holdingsBody = document.getElementById('holdingsBody');
    const alertsList = document.getElementById('alertsList');
    const portfolioFile = document.getElementById('portfolioFile');
    const uploadPortfolioBtn = document.getElementById('uploadPortfolioBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // charts
    let allocChart = null;
    let portfolioLineChart = null;

    // IPO elements
    const openIpoAnalyzerBtn = document.getElementById('openIpoAnalyzerBtn');
    const ipoAnalyzerModal = document.getElementById('ipoAnalyzerModal');
    const closeIpoAnalyzer = document.getElementById('closeIpoAnalyzer');
    const ipoFileInput = document.getElementById('ipoFileInput');
    const ipoTextInput = document.getElementById('ipoTextInput');
    const analyzeIpoBtn = document.getElementById('analyzeIpoBtn');
    const saveIpoBtn = document.getElementById('saveIpoBtn');
    const refreshReportsAfterSave = document.getElementById('refreshReportsAfterSave');
    const ipoResultArea = document.getElementById('ipoResultArea');

    const ipoListEl = document.getElementById('ipoList');
    const refreshIpoBtn = document.getElementById('refreshIpoBtn');
    const compareIpoBtn = document.getElementById('compareIpoBtn');
    const ipoModal = document.getElementById('ipoModal');
    const ipoModalTitle = document.getElementById('ipoModalTitle');
    const ipoModalMeta = document.getElementById('ipoModalMeta');
    const ipoModalContent = document.getElementById('ipoModalContent');
    const ipoModalClose = document.getElementById('ipoModalClose');
    const ipoModalOpenRaw = document.getElementById('ipoModalOpenRaw');
    const ipoCompareResult = document.getElementById('ipoCompareResult');
    const ipoCompareBody = document.getElementById('ipoCompareBody');
    const refreshHistoryBtn = document.getElementById('refreshHistoryBtn');

    // showdown for markdown -> html
    const showdownConverter = new showdown.Converter();

    // helper escape
    function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // -------------------------
    // Dashboard load
    // -------------------------
    async function loadDashboard(){
      try {
        const res = await fetch('/portfolio', { credentials: 'same-origin' });
        if (res.status === 401) { window.location.href = '/login'; return; }
        const j = await res.json();
        if (j.error) { console.error(j); return; }

        totalValueEl.textContent = j.total_value ? `₹${Number(j.total_value).toLocaleString('en-IN')}` : '—';

        holdingsBody.innerHTML = '';
        (j.holdings||[]).forEach(h=>{
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50 transition-colors';
          tr.innerHTML = `
            <td class="p-4 font-semibold text-gray-900">${h.symbol}</td>
            <td class="p-4 text-gray-700">${h.quantity}</td>
            <td class="p-4 text-gray-700">₹${h.avg_price ?? '—'}</td>
            <td class="p-4 text-gray-700">₹${h.last_price ?? '—'}</td>
            <td class="p-4 font-semibold text-gray-900">₹${Number(h.current_value||0).toLocaleString('en-IN')}</td>
          `;
          holdingsBody.appendChild(tr);
        });

        // allocation pie (same as before)
        const alloc = j.allocations || {};
        const labels = Object.keys(alloc);
        const values = Object.values(alloc);

        if (allocChart) { allocChart.destroy(); allocChart = null; }
        if (labels.length) {
          const ctx = document.getElementById('allocChart').getContext('2d');
          allocChart = new Chart(ctx, {
            type: 'pie',
            data: { labels, datasets:[{ data: values, borderWidth:3, borderColor:'#fff' }] },
            options: { plugins:{ legend:{ position:'bottom' } }, maintainAspectRatio:false }
          });
        }

        // alerts
        alertsList.innerHTML = '';
        (j.alerts||[]).forEach(a=>{
          const container = document.createElement('div');
          container.className = 'p-4 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl';
          container.innerHTML = `
            <div class="flex justify-between items-start mb-3">
              <div>
                <div class="font-semibold text-amber-900 font-display">${escapeHtml(a.symbol)} — ${escapeHtml(a.sentiment)}</div>
                <div class="text-sm text-amber-700 font-medium">Estimated move: ${a.estimated_pct_move}%</div>
              </div>
            </div>
            <div class="text-sm text-amber-800">
              <strong class="font-semibold">Recent Headlines:</strong>
              <ul class="list-disc list-inside mt-2 space-y-1 text-amber-700">
                ${ (a.headlines||[]).slice(0,5).map(h=>`<li>${escapeHtml(h)}</li>`).join('') }
              </ul>
            </div>
          `;
          alertsList.appendChild(container);
        });

      } catch (e) {
        console.error('loadDashboard error', e);
      }
    }

    // -------------------------
    // Portfolio history (6 months) line chart
    // Backend route expected: GET /portfolio/history?months=6 -> { history: [{date:'YYYY-MM-DD', value:NUM}, ...] }
    // -------------------------
    async function loadPortfolioHistory(months=6){
      try {
        const res = await fetch(`/portfolio/history?months=${encodeURIComponent(months)}`, { credentials: 'same-origin' });
        if (!res.ok) {
          console.warn('No /portfolio/history endpoint or failed to fetch history; skipping line chart.');
          return;
        }
        const j = await res.json();
        const hist = j.history || [];
        if (!hist.length) return;

        // convert to arrays for Chart.js
        const labels = hist.map(r => r.date);
        const values = hist.map(r => Number(r.value || 0));

        const ctx = document.getElementById('portfolioLineChart').getContext('2d');
        if (portfolioLineChart) portfolioLineChart.destroy();
        portfolioLineChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Portfolio Value (₹)',
              data: values,
              fill: true,
              tension: 0.15,
              pointRadius: 2
            }]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: { y: { beginAtZero: false } }
          }
        });
      } catch (e) {
        console.error('loadPortfolioHistory error', e);
      }
    }

    // -------------------------
    // IPO analyzer (modal) behavior
    // -------------------------
    function openIpoAnalyzer(){
      ipoAnalyzerModal.classList.remove('hidden');
      ipoAnalyzerModal.classList.add('flex');
      ipoResultArea.innerHTML = '';
      saveIpoBtn.classList.add('hidden');
      refreshReportsAfterSave.classList.add('hidden');
      ipoFileInput.value = '';
      ipoTextInput.value = '';
    }
    function closeIpoAnalyzerModal(){
      ipoAnalyzerModal.classList.add('hidden');
      ipoAnalyzerModal.classList.remove('flex');
    }

    openIpoAnalyzerBtn.addEventListener('click', openIpoAnalyzer);
    closeIpoAnalyzer.addEventListener('click', closeIpoAnalyzerModal);
    ipoAnalyzerModal.addEventListener('click', (e)=>{ if (e.target===ipoAnalyzerModal) closeIpoAnalyzerModal(); });

    // Submit: call /ipo/analyze (backend already saves and returns report_id)
    document.getElementById('ipoAnalyzerForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      ipoResultArea.innerHTML = '<div class="text-sm text-gray-500">Analyzing — please wait...</div>';
      try {
        const file = ipoFileInput.files && ipoFileInput.files[0];
        const pasted = (ipoTextInput.value || '').trim();
        let res;
        if (file) {
          const fd = new FormData();
          fd.append('ipoFile', file);
          res = await fetch('/ipo/analyze', { method: 'POST', body: fd, credentials: 'same-origin' });
        } else if (pasted) {
          res = await fetch('/ipo/analyze', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ content: pasted }), credentials: 'same-origin' });
        } else {
          ipoResultArea.innerHTML = '<div class="text-sm text-red-600">Provide a PDF or paste content.</div>';
          return;
        }

        if (!res.ok) {
          const t = await res.text().catch(()=>null);
          throw new Error(t || `HTTP ${res.status}`);
        }
        const j = await res.json();
        if (j.error) throw new Error(j.error || 'Unknown error');

        const md = j.ipo_report_md || j.ipo_report || '';
        const html = showdownConverter.makeHtml(md || '');
        ipoResultArea.innerHTML = html || '<div class="text-sm text-gray-500">No report returned.</div>';

        // if backend returned a report_id (saved), show 'View saved' and refresh hint
        if (j.report_id) {
          saveIpoBtn.classList.add('hidden');
          refreshReportsAfterSave.classList.remove('hidden');
          refreshReportsAfterSave.onclick = () => { loadIpoReports(); refreshReportsAfterSave.classList.add('hidden'); };
          ipoResultArea.insertAdjacentHTML('afterbegin', `<div class="text-sm text-green-600 mb-2">Report saved (id: ${j.report_id})</div>`);
        } else {
          // If backend didn't save (for some reason), show Save button which calls analyze again to ensure persistence
          saveIpoBtn.classList.remove('hidden');
          saveIpoBtn.onclick = async () => {
            // attempt save by calling /ipo/analyze with same content (backend saves on analyze)
            try {
              let r;
              if (file) {
                const fd2 = new FormData();
                fd2.append('ipoFile', file);
                r = await fetch('/ipo/analyze', { method: 'POST', body: fd2, credentials: 'same-origin' });
              } else {
                r = await fetch('/ipo/analyze', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ content: pasted }), credentials: 'same-origin' });
              }
              const jr = await r.json();
              if (jr.report_id) {
                saveIpoBtn.classList.add('hidden');
                refreshReportsAfterSave.classList.remove('hidden');
                refreshReportsAfterSave.onclick = () => { loadIpoReports(); refreshReportsAfterSave.classList.add('hidden'); };
                ipoResultArea.insertAdjacentHTML('afterbegin', `<div class="text-sm text-green-600 mb-2">Report saved (id: ${jr.report_id})</div>`);
              } else {
                alert('Save attempt did not return a report id.');
              }
            } catch (err) {
              console.error('saveIpoBtn error', err);
              alert('Save failed — see console.');
            }
          };
        }

      } catch (err) {
        console.error('ipo analyze error', err);
        ipoResultArea.innerHTML = `<div class="text-sm text-red-600">Analysis failed: ${escapeHtml(err.message || String(err))}</div>`;
      }
    });

    refreshReportsAfterSave && refreshReportsAfterSave.addEventListener('click', ()=>{ loadIpoReports(); });

    // -------------------------
    // Load and show saved IPO reports
    // -------------------------
    let currentIpoReports = [];
    async function loadIpoReports(){
      ipoListEl.innerHTML = 'Loading...';
      try {
        const res = await fetch('/ipo/list', { credentials: 'same-origin' });
        if (res.status === 401) { ipoListEl.innerHTML = '<div class="text-sm text-gray-600">Login required to view IPO reports.</div>'; return; }
        const j = await res.json();
        currentIpoReports = j.reports || [];
        if (!currentIpoReports.length) {
          ipoListEl.innerHTML = '<div class="text-sm text-gray-600">No saved IPO reports yet.</div>';
          ipoCompareResult.classList.add('hidden');
          return;
        }
        ipoListEl.innerHTML = '';
        currentIpoReports.forEach(r=>{
          const id = r.id;
          const card = document.createElement('div');
          card.className = 'p-3 border border-gray-100 rounded-lg flex items-start justify-between';
          card.innerHTML = `
            <div class="flex items-start gap-3">
              <input data-id="${id}" type="checkbox" class="ipo-checkbox mt-2" />
              <div>
                <div class="font-semibold text-gray-900">${escapeHtml(r.title || ('Report #' + id))}</div>
                <div class="text-sm text-gray-500 mt-1">${r.created_at ? new Date(r.created_at).toLocaleString() : ''}</div>
                <div class="mt-2 text-xs text-gray-500">Score: ${r.sebi_score ?? r.llm_score ?? 'N/A'}</div>
              </div>
            </div>
            <div class="flex flex-col items-end gap-2">
              <button data-id="${id}" class="viewIpoBtn px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-sm">View</button>
              <a href="/ipo/get/${id}" target="_blank" rel="noopener" class="text-xs text-gray-600 hover:underline">Open JSON</a>
            </div>
          `;
          ipoListEl.appendChild(card);
        });

        document.querySelectorAll('.viewIpoBtn').forEach(btn=>{
          btn.addEventListener('click', ev=>{
            const id = ev.currentTarget.getAttribute('data-id');
            viewIpoReport(Number(id));
          });
        });

      } catch (e) {
        console.error('loadIpoReports error', e);
        ipoListEl.innerHTML = '<div class="text-sm text-red-600">Failed to load IPO reports.</div>';
      }
    }

    async function viewIpoReport(id){
      try {
        const res = await fetch(`/ipo/get/${id}`, { credentials: 'same-origin' });
        if (!res.ok) {
          const j = await res.json().catch(()=>null);
          alert(j?.error || 'Failed to load report');
          return;
        }
        const j = await res.json();
        ipoModalTitle.textContent = j.title || `Report #${j.id}`;
        ipoModalMeta.textContent = j.created_at ? `Created: ${new Date(j.created_at).toLocaleString()}` : '';
        ipoModalContent.textContent = j.content_md || '';
        ipoModalOpenRaw.onclick = ()=> window.open(`/ipo/get/${id}`, '_blank');
        ipoModal.classList.remove('hidden'); ipoModal.classList.add('flex'); document.body.style.overflow='hidden';
      } catch (e) {
        console.error('viewIpoReport err', e);
        alert('Failed to fetch report — see console.');
      }
    }
    ipoModalClose.addEventListener('click', ()=>{ ipoModal.classList.add('hidden'); ipoModal.classList.remove('flex'); document.body.style.overflow=''; ipoModalContent.textContent=''; });
    ipoModal.addEventListener('click', (e)=>{ if (e.target===ipoModal) { ipoModal.classList.add('hidden'); ipoModal.classList.remove('flex'); document.body.style.overflow=''; ipoModalContent.textContent=''; } });

    // Compare selected IPOs
    async function compareSelectedIpos(){
      ipoCompareBody.innerHTML = '';
      ipoCompareResult.classList.add('hidden');
      const checked = Array.from(document.querySelectorAll('.ipo-checkbox:checked')).map(cb=>cb.getAttribute('data-id'));
      if (!checked.length) { alert('Select at least 1 report to compare.'); return; }
      const query = checked.join(',');
      try {
        const res = await fetch(`/ipo/compare?ids=${encodeURIComponent(query)}`, { credentials: 'same-origin' });
        if (!res.ok) { const j = await res.json().catch(()=>null); alert(j?.error||'Failed to compare'); return; }
        const j = await res.json();
        const rows = j.comparison || [];
        if (!rows.length) { alert('No reports found.'); return; }
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2 font-medium text-gray-800">${escapeHtml(r.title||'Report')}</td>
            <td class="p-2 text-xs text-gray-600">${r.created_at?new Date(r.created_at).toLocaleString():''}</td>
            <td class="p-2 text-sm text-gray-700">${escapeHtml(String(r.revenue || '—'))}</td>
            <td class="p-2 text-sm text-gray-700">${escapeHtml(String(r.profit || '—'))}</td>
            <td class="p-2 text-sm text-gray-700">${escapeHtml(String(r.debt || '—'))}</td>
            <td class="p-2 text-sm text-gray-700">${r.promoter_mentioned ? 'Yes':'No'}</td>
            <td class="p-2 text-sm font-semibold text-gray-900">${r.overall_score ?? 'N/A'}</td>
          `;
          ipoCompareBody.appendChild(tr);
        });
        ipoCompareResult.classList.remove('hidden');
        ipoCompareResult.scrollIntoView({ behavior: 'smooth' });
      } catch (e) {
        console.error('compareSelectedIpos error', e); alert('Compare failed — see console.');
      }
    }

    // -------------------------
    // Upload portfolio file
    // -------------------------
    uploadPortfolioBtn.addEventListener('click', async ()=>{
      const file = portfolioFile.files[0];
      if (!file) { alert('Select a CSV or XLSX file first'); return; }
      const fd = new FormData(); fd.append('file', file);
      uploadPortfolioBtn.disabled = true; uploadPortfolioBtn.textContent = 'Uploading...';
      try {
        const res = await fetch('/portfolio/upload', { method:'POST', body: fd, credentials:'same-origin' });
        const j = await res.json();
        if (res.ok && j.success) { await loadDashboard(); await loadPortfolioHistory(6); }
        else alert(j.error || JSON.stringify(j));
      } catch (e) { console.error(e); alert('Upload failed — see console.'); }
      finally { uploadPortfolioBtn.disabled=false; uploadPortfolioBtn.textContent='Upload & Analyze'; portfolioFile.value=''; }
    });

    // refresh handlers
    refreshIpoBtn.addEventListener('click', loadIpoReports);
    compareIpoBtn.addEventListener('click', compareSelectedIpos);
    refreshHistoryBtn.addEventListener('click', ()=>loadPortfolioHistory(6));

    // logout
    logoutBtn.addEventListener('click', async ()=>{
      try { const res = await fetch('/auth/logout', { method:'POST', credentials:'same-origin' }); const j = await res.json(); if (j.success) window.location.href='/login'; }
      catch(e){ console.error('logout', e); alert('Logout failed.'); }
    });

    // initial load
    (async ()=>{
      await loadDashboard();
      await loadPortfolioHistory(6); // request backend history
      await loadIpoReports();
      setInterval(loadDashboard, 60*1000);
    })();
  </script>
</body>
</html>
