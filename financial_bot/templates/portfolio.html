<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio Analysis - SEBI Saathi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-2: #7c3aed;
    }
    html,body { height: 100%; font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg,#f8fafc,#eef2ff); }
    .container { max-width: 1100px; margin: 2.5rem auto; padding: 1rem; }
    .card { background: var(--card); border-radius: 12px; padding: 1.25rem; box-shadow: 0 6px 20px rgba(2,6,23,0.04); border: 1px solid #eef2f7; }
    .panel-title { font-weight:700; color:#0f172a; }
    .muted { color:var(--muted); }
    .small { font-size:0.88rem; color:var(--muted); }
    .chart-wrap { display:flex; align-items:center; justify-content:center; padding: 1rem; }
    table { width:100%; border-collapse:collapse; }
    thead th { text-align:left; font-weight:600; color:#111827; padding:0.6rem 0.75rem; font-size:0.92rem; border-bottom:1px solid #eef2f7; }
    tbody td { padding:0.6rem 0.75rem; border-bottom:1px solid #f3f4f6; font-size:0.92rem; color:#374151; }
    .value { font-weight:600; color:#0f172a; }
    .no-data { padding:2rem; text-align:center; color:var(--muted); }
    .legend { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.75rem; font-size:0.9rem; color:#374151 }
    .legend-item { display:flex; gap:0.5rem; align-items:center; }
    .color-dot { width:12px; height:12px; border-radius:3px; display:inline-block; }
    @media (min-width: 1024px) { .layout { display:grid; grid-template-columns: 420px 1fr; gap:1.25rem; align-items:start; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" style="margin-bottom:1rem;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div class="panel-title">Portfolio Analysis</div>
          <div class="small muted">AI-powered insights — quick summary of portfolio health</div>
        </div>
        <div class="small muted">Generated: <strong style="font-weight:600;color:#059669">Just now</strong></div>
      </div>
    </div>

    <div class="layout">
      <!-- Left: Chart + Composition -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
          <div style="font-weight:700;color:#0f172a;">Portfolio Composition</div>
          <div class="small muted">By Investment Value</div>
        </div>

        <div id="chartContainer" class="chart-wrap" aria-hidden="false">
          <canvas id="compositionChart" style="max-width:380px; width:100%; height:320px;"></canvas>
        </div>

        <div id="legend" class="legend" aria-hidden="false"></div>

        <div id="chartFallback" class="no-data" style="display:none;">No composition data available to render chart.</div>
      </div>

      <!-- Right: Analysis Markdown & Holdings -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
          <div style="font-weight:700;color:#0f172a;">Analysis</div>
          <div class="small muted">Narrative produced by SEBI Saathi</div>
        </div>

        <div id="analysisHtml" class="prose muted" style="line-height:1.6;"></div>

        <hr style="border:none;border-top:1px solid #f1f5f9;margin:1rem 0;">

        <div style="font-weight:700;margin-bottom:0.5rem;color:#0f172a">Holdings</div>
        <div style="overflow:auto">
          <table aria-describedby="holdings-desc">
            <thead>
              <tr>
                <th>Ticker</th>
                <th style="width:96px">Qty</th>
                <th style="width:130px">Value (₹)</th>
                <th style="width:96px">Alloc %</th>
              </tr>
            </thead>
            <tbody id="holdingsBody">
              <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>

        <div id="holdingsEmpty" class="no-data" style="display:none;">No holdings provided.</div>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  (function(){
    // read payload placed in sessionStorage by the main app
    let payload = null;
    try {
      const raw = sessionStorage.getItem('sebi_portfolio_analysis');
      if (raw) payload = JSON.parse(raw);
    } catch (e) {
      console.error('Failed to read portfolio payload from sessionStorage', e);
    }

    // if no payload, show message and bail
    if (!payload) {
      document.getElementById('analysisHtml').innerHTML = '<p class="small muted">No analysis data found. Please upload a portfolio from the main page and view the report.</p>';
      document.getElementById('chartContainer').style.display = 'none';
      document.getElementById('chartFallback').style.display = 'block';
      document.getElementById('holdingsEmpty').style.display = 'block';
      return;
    }

    // convert markdown -> html for analysis section
    const converter = new showdown.Converter({simplifiedAutoLink: true, tables: true, tasklists: true});
    const analysisMd = payload.analysis_markdown || payload.analysis_html || '';
    const analysisHtml = analysisMd ? converter.makeHtml(analysisMd) : (payload.analysis_html || '');
    document.getElementById('analysisHtml').innerHTML = analysisHtml || '<p class="small muted">No narrative provided.</p>';

    // prepare chart data
    const chartData = payload.chart_data || {};
    const labels = Object.keys(chartData);
    const values = Object.values(chartData);

    // colors (re-used for legend). Expand if you expect more categories.
    const COLORS = ['#3b82f6','#f97316','#ef4444','#06b6d4','#10b981','#a78bfa','#9ca3af','#f59e0b','#8b5cf6','#ec4899'];

    function formatCurrency(n) {
      if (n == null || isNaN(n)) return '-';
      return Number(n).toLocaleString('en-IN', {maximumFractionDigits:0});
    }

    // render chart or fallback
    let chartInstance = null;
    try {
      if (labels.length && values.length && values.some(v => v > 0)) {
        const ctx = document.getElementById('compositionChart').getContext('2d');
        chartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: values,
              backgroundColor: COLORS.slice(0, labels.length),
              borderColor: '#fff',
              borderWidth: 1
            }]
          },
          options: {
            plugins: {
              legend: { display: false }, // we will render a custom legend
              tooltip: { callbacks: { label: function(context){ const v = context.raw || 0; return context.label + ': ₹' + formatCurrency(v); } } }
            },
            maintainAspectRatio: false,
            cutout: '48%'
          }
        });

        // custom legend
        const legendEl = document.getElementById('legend');
        legendEl.innerHTML = '';
        labels.forEach((lab, idx) => {
          const dot = COLORS[idx % COLORS.length];
          const el = document.createElement('div');
          el.className = 'legend-item';
          el.innerHTML = `<span class="color-dot" style="background:${dot}"></span><span>${lab} — <strong class="value">₹${formatCurrency(values[idx])}</strong></span>`;
          legendEl.appendChild(el);
        });
      } else {
        document.getElementById('chartContainer').style.display = 'none';
        document.getElementById('chartFallback').style.display = 'block';
      }
    } catch (e) {
      console.error('chart render error', e);
      document.getElementById('chartContainer').style.display = 'none';
      document.getElementById('chartFallback').style.display = 'block';
    }

    // holdings rendering: expects either payload.holdings (array of objects with symbol/qty/value/pct)
    // or fallback to generating rows from chart_data keys
    try {
      const holdings = payload.holdings || (payload.holdings_table || []);
      const tbody = document.getElementById('holdingsBody');
      if (Array.isArray(holdings) && holdings.length) {
        tbody.innerHTML = '';
        holdings.forEach(h => {
          const symbol = h.symbol || h.ticker || h.name || '';
          const qty = (h.quantity !== undefined ? h.quantity : (h.qty !== undefined ? h.qty : ''));
          const value = (h.current_value !== undefined ? h.current_value : (h.value !== undefined ? h.value : null));
          const pct = (h.alloc !== undefined ? h.alloc : (h.pct !== undefined ? h.pct : null));
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="py-2">${symbol}</td>
                          <td class="py-2">${qty}</td>
                          <td class="py-2">₹${value != null ? formatCurrency(value) : '-'}</td>
                          <td class="py-2">${pct != null ? Number(pct).toFixed(2) + '%' : '-'}</td>`;
          tbody.appendChild(tr);
        });
        document.getElementById('holdingsEmpty').style.display = 'none';
      } else if (labels.length) {
        // build simple holdings table from chart_data entries
        tbody.innerHTML = '';
        let total = values.reduce((a,b) => a + Number(b || 0), 0) || 1;
        labels.forEach((lab, idx) => {
          const v = Number(values[idx] || 0);
          const pct = total ? (v/total * 100) : 0;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="py-2">${lab}</td>
                          <td class="py-2">-</td>
                          <td class="py-2">₹${formatCurrency(v)}</td>
                          <td class="py-2">${pct.toFixed(2)}%</td>`;
          tbody.appendChild(tr);
        });
        document.getElementById('holdingsEmpty').style.display = 'none';
      } else {
        // no holdings info
        tbody.innerHTML = '';
        document.getElementById('holdingsEmpty').style.display = 'block';
      }
    } catch (e) {
      console.error('holdings render error', e);
      document.getElementById('holdingsEmpty').style.display = 'block';
    }

    // cleanup: remove stored payload so user doesn't see stale data next time (optional)
    try { sessionStorage.removeItem('sebi_portfolio_analysis'); } catch(e){}
  })();
  </script>
</body>
</html>
